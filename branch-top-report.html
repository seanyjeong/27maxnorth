<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지점별 종합 1등 리포트</title>
    
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4361ee; 
            --gold: #FFD700;
            --background: #000000;
            --card-bg: #1a1a1a;
            --text-primary: #FFFFFF;
            --text-secondary: #AAAAAA;
            --border-color: #333333;
        }
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            margin: 0;
            padding: 24px; 
            background-color: var(--background); 
            color: var(--text-primary); 
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--primary);
            margin: 10px 0 30px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-top: 2px solid var(--primary);
            margin-top: 20px;
        }
        th, td {
            border: none;
            border-bottom: 1px solid var(--border-color);
            padding: 16px 10px;
            text-align: center;
            white-space: nowrap;
        }
        th {
            background-color: #222;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 16px 10px;
        }
        td {
            font-size: 1.3rem;
        }
        tbody tr:hover { background-color: #2a2a2a; }

        td:nth-child(1) { font-weight: 700; color: var(--primary); }
        td:nth-child(2) { font-weight: 600; }
        td:nth-child(3) { font-weight: 700; color: var(--text-primary); } 
        
        td:nth-child(n+4) {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }
        td span {
            color: var(--text-primary);
            font-weight: 600;
        }

        .loader-overlay { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 999; justify-content: center; align-items: center; }
        .loader { border: 8px solid #333; border-top: 8px solid var(--primary); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            body { padding: 8px; }
            h1 { font-size: 2rem; }
            .container { overflow-x: auto; }
            th, td { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <div class="loader-overlay" id="loaderOverlay"><div class="loader"></div></div>

    <div class="container">
        <h1>지점별 종합 1등 리포트</h1>

        <table>
            <thead>
                <tr>
                    <th>지점</th>
                    <th>이름 (성별)</th>
                    <th>총점</th>
                    <th>제멀 (기록/점수)</th>
                    <th>메디신볼 (기록/점수)</th>
                    <th>10m (기록/점수)</th>
                    <th>배근력 (기록/점수)</th>
                    <th>좌전굴 (기록/점수)</th>
                </tr>
            </thead>
            <tbody id="report-tbody">
            </tbody>
        </table>
    </div>

    <script>
        const API_URL = 'https://supermax.kr';
        const EVENTS = ['제멀', '메디신볼', '10m', '배근력', '좌전굴'];
        
        const ALLOWED_BRANCHES = [
            '군포', '분당', '수원', '영통', '이천', '동탄', '용인', '강남', '강동', 
            '서초', '하남', '인천서구', '일산', '부천', '인천연수', '강릉', '원주', 
            '의정부', '인천계양', '철원', '포천', '속초.동해', '송파', '인천검단'
        ];

        let allTopStudents = [];

        window.onload = loadAllBranchTopStudents;

        function showLoader(show) {
            document.getElementById('loaderOverlay').style.display = show ? 'flex' : 'none';
        }

        async function loadAllBranchTopStudents() {
            showLoader(true);
            try {
                const fetchTasks = ALLOWED_BRANCHES.map(branchName => 
                    fetchBranchReport(branchName)
                );
                
                const results = await Promise.all(fetchTasks);

                results.forEach(result => {
                    if (!result.success || !result.data || result.data.length === 0) {
                        return; // 지점 데이터 없으면 스킵
                    }
                    
                    // ⭐️⭐️⭐️ [수정] 0점짜리 학생 제외 ⭐️⭐️⭐️
                    const validStudents = result.data.filter(s => s.totalScore > 0);
                    
                    // 0점 넘는 학생이 없으면 이 지점은 스킵
                    if (validStudents.length === 0) {
                        return;
                    }

                    // ⭐️ 유효한 학생 중에서 1등 찾기 ⭐️
                    const branchTopStudent = validStudents.reduce((top, current) => {
                        return (current.totalScore > top.totalScore) ? current : top;
                    }, validStudents[0]); // 0점 초과 학생 중 첫 번째를 기준으로
                    
                    allTopStudents.push({ branch: result.branchName, ...branchTopStudent });
                });
                
                renderTable();

            } catch (err) {
                console.error("전체 리포트 로딩 중 오류 발생:", err);
                alert("데이터를 불러오는 데 실패했습니다.");
            } finally {
                showLoader(false);
            }
        }

        async function fetchBranchReport(branchName) {
            try {
                const response = await fetch(`${API_URL}/26susi/branch-report?branchName=${encodeURIComponent(branchName)}`);
                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }
                const result = await response.json();
                return { branchName, ...result };
            } catch (error) {
                console.error(`${branchName} 리포트 로딩 실패:`, error);
                return { branchName, success: false, data: [] };
            }
        }

        function renderTable() {
            const tbody = document.getElementById('report-tbody');
            tbody.innerHTML = '';
            
            const data = allTopStudents;
            if (!data || data.length === 0) {
                const colCount = 3 + EVENTS.length;
                tbody.innerHTML = `<tr><td colspan="${colCount}">실기 시작 이후 업데이트. </td></tr>`;
                return;
            }

            data.sort((a, b) => b.totalScore - a.totalScore);

            data.forEach(s => {
                const row = document.createElement('tr');
                
                let rowHtml = `
                    <td>${s.branch}</td>
                    <td>${s.name} (${s.gender})</td>
                    <td>${s.totalScore}점</td>
                `;

                EVENTS.forEach(eventKey => {
                    rowHtml += formatCell(s.records[eventKey], eventKey);
                });

                row.innerHTML = rowHtml;
                tbody.appendChild(row);
            });
        }

        function formatCell(recordData, eventKey) {
            if (!recordData) {
                return '<td>-</td>';
            }

            let recordDisplay;
            if (recordData.record === 0 && recordData.score === 52) {
                recordDisplay = 'F';
            } else {
                recordDisplay = recordData.record;
                if (eventKey === '10m') recordDisplay += '초';
            }

            return `<td>${recordDisplay} (<span>${recordData.score}점</span>)</td>`;
        }
    </script>
</body>
</html>