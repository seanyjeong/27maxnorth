<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지점 결과 리포트</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            padding: 20px; 
            background-color: #f4f4f8; 
            margin: 0;
        }
        .container { 
            max-width: 95%; 
            margin: auto; 
        }
        h1 { 
            text-align: center; 
        }

        /* 레이아웃: 왼쪽 지점 목록 + 오른쪽 리포트 */
        .layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .card { 
            background-color: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
        }

        /* 지점 목록 카드 */
        .branch-list-card {
            width: 220px;
            flex-shrink: 0;
        }
        .branch-list-title {
            margin-top: 0;
            margin-bottom: 12px;
            font-size: 1rem;
            text-align: center;
        }
        #branch-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .branch-btn {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background-color: #ffffff;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: left;
            transition: background-color 0.15s, border-color 0.15s, transform 0.1s;
        }
        .branch-btn:hover {
            background-color: #f1f3f5;
            transform: translateY(-1px);
        }
        .branch-btn.active {
            background-color: #007bff;
            color: #ffffff;
            border-color: #007bff;
        }

        /* 오른쪽 메인 영역 */
        .content-area {
            flex: 1;
            min-width: 0;
        }

        .toolbar { 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .toolbar button { 
            padding: 10px 20px; 
            border: 1px solid #ccc; 
            background-color: white; 
            color: #333; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: 500; 
            font-size: 1rem; 
        }
        .toolbar .excel-btn { 
            background-color: #198754; 
            color: white; 
            border: none; 
        }
        .filter-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .toolbar select { 
            padding: 10px; 
            border-radius: 5px; 
            border: 1px solid #ccc; 
            font-size: 1rem; 
        }

        .averages-card { 
            display: flex; 
            justify-content: space-around; 
            text-align: center; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .average-item { 
            flex: 1; 
            min-width: 120px; 
        }
        .average-item h3 { 
            margin: 0 0 5px 0; 
            font-size: 0.9rem; 
            color: #6c757d; 
        }
        .average-item p { 
            margin: 0; 
            font-size: 1.3rem; 
            font-weight: bold; 
            color: #007bff; 
        }

        .table-container { 
            overflow-y: auto; 
            max-height: 70vh; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.9rem; 
        }
        td { 
            padding: 8px; 
            border: 1px solid #ddd; 
            text-align: center; 
            white-space: nowrap; 
            background: white; 
        }
        tbody tr:hover td { 
            background-color: #f1f1f1; 
        }
        th { 
            position: sticky; 
            top: -1px; 
            background: #f8f9fa; 
            font-weight: 600; 
            z-index: 1; 
            padding: 8px; 
            border: 1px solid #ddd; 
            text-align: center; 
            white-space: nowrap; 
        }
        thead tr:nth-child(2) th { 
            top: 37px; 
        }
        th.sortable { 
            cursor: pointer; 
            user-select: none; 
        }
        th.sortable:hover { 
            background-color: #e2e6ea; 
        }

        @media (max-width: 900px) {
            .layout {
                flex-direction: column;
            }
            .branch-list-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="main-content" class="container">
        <h1 id="report-title">지점 결과 리포트</h1>

        <div class="layout">
            <!-- 왼쪽: 지점 목록 -->
            <div class="card branch-list-card">
                <h2 class="branch-list-title">지점 목록</h2>
                <div id="branch-list">
                    <!-- 지점 버튼이 동적으로 추가됨 -->
                </div>
            </div>

            <!-- 오른쪽: 리포트 영역 -->
            <div class="content-area">
                <div class="toolbar">
                    <div class="filter-group">
                        <label for="gender-filter">성별 필터:</label>
                        <select id="gender-filter" onchange="filterByGender()">
                            <option value="all">전체</option>
                            <option value="남">남자</option>
                            <option value="여">여자</option>
                        </select>
                    </div>
                    <button class="excel-btn" onclick="downloadExcel()">엑셀로 다운로드</button>
                </div>

                <div class="card averages-card">
                    <div class="average-item"><h3>제멀 평균</h3><p id="avg-jemul">-</p></div>
                    <div class="average-item"><h3>메디신볼 평균</h3><p id="avg-medball">-</p></div>
                    <div class="average-item"><h3>10m 왕복 평균</h3><p id="avg-10m">-</p></div>
                    <div class="average-item"><h3>배근력 평균</h3><p id="avg-backstr">-</p></div>
                    <div class="average-item"><h3>좌전굴 평균</h3><p id="avg-flex">-</p></div>
                </div>

                <div class="card table-container" style="margin-top: 20px; padding: 0;">
                    <table id="report-table">
                        <thead>
                            <tr>
                                <th rowspan="2">No.</th>
                                <th rowspan="2">성별</th>
                                <th rowspan="2">이름</th>
                                <!-- 총점 정렬 가능 -->
                                <th class="sortable" rowspan="2" onclick="sortReport('totalScore')">총점</th>
                                <!-- 지점 내 종합 순위 -->
                                <th class="sortable" rowspan="2" onclick="sortReport('overallRank')">종합순위(지점)</th>
                                <th colspan="3">제자리멀리뛰기</th>
                                <th colspan="3">메디신볼</th>
                                <th colspan="3">10m 왕복</th>
                                <th colspan="3">배근력</th>
                                <th colspan="3">좌전굴</th>
                            </tr>
                            <tr>
                                <th>기록</th><th>점수</th><th class="sortable" onclick="sortReport('제멀')">순위</th>
                                <th>기록</th><th>점수</th><th class="sortable" onclick="sortReport('메디신볼')">순위</th>
                                <th>기록</th><th>점수</th><th class="sortable" onclick="sortReport('10m')">순위</th>
                                <th>기록</th><th>점수</th><th class="sortable" onclick="sortReport('배근력')">순위</th>
                                <th>기록</th><th>점수</th><th class="sortable" onclick="sortReport('좌전굴')">순위</th>
                            </tr>
                        </thead>
                        <tbody id="report-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://supermax.kr';
        let currentBranch = '';
        let branchData = [];          // 해당 지점 전체 학생 데이터
        const EVENTS = {              // 종목 → 평균 표시용 ID
            '제멀': 'avg-jemul', 
            '메디신볼': 'avg-medball', 
            '10m': 'avg-10m', 
            '배근력': 'avg-backstr', 
            '좌전굴': 'avg-flex' 
        };
        let sortDirections = {};      // 각 정렬 기준의 현재 방향(asc/desc)

        // 1) 페이지 로드시 지점 목록 불러오기
        async function loadBranches() {
            const branchListEl = document.getElementById('branch-list');
            branchListEl.innerHTML = '지점 목록 로딩 중...';

            try {
                const res = await fetch(`${API_URL}/26susi/dashboard/pre-event`);
                const result = await res.json();

                if (!result.success) {
                    branchListEl.innerHTML = '지점 데이터를 불러오지 못했습니다.';
                    return;
                }

                // 지점 이름 리스트 만들기
                const branches = result.data
                    .map(item => item.branch_name)
                    .filter((v, i, arr) => v && arr.indexOf(v) === i) // 중복 제거
                    .sort((a, b) => a.localeCompare(b, 'ko-KR'));

                if (branches.length === 0) {
                    branchListEl.innerHTML = '표시할 지점이 없습니다.';
                    return;
                }

                branchListEl.innerHTML = branches.map(name => `
                    <button class="branch-btn" onclick="selectBranch('${name}')">${name}</button>
                `).join('');

                // 첫 지점 자동 선택
                selectBranch(branches[0]);
            } catch (error) {
                console.error('지점 목록 로딩 오류:', error);
                branchListEl.innerHTML = '지점 목록을 불러오는 데 실패했습니다.';
            }
        }

        // 2) 지점 선택
        function selectBranch(branchName) {
            currentBranch = branchName;
            document.getElementById('report-title').textContent = `${currentBranch} 교육원 결과 리포트`;

            // 버튼 active 표시
            const buttons = document.querySelectorAll('.branch-btn');
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.textContent === branchName);
            });

            fetchReportData();
        }

        // 3) 해당 지점 리포트 데이터 불러오기 (⚠️ /all-ranks 호출 없음!)
        async function fetchReportData() {
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = `<tr><td colspan="20">데이터 로딩 중...</td></tr>`;

            if (!currentBranch) {
                tbody.innerHTML = `<tr><td colspan="20">지점을 선택해 주세요.</td></tr>`;
                return;
            }

            try {
                const branchRes = await fetch(`${API_URL}/26susi/branch-report?branchName=${encodeURIComponent(currentBranch)}`);
                const branchResult = await branchRes.json();

                if (branchResult.success) {
                    branchData = branchResult.data;   // [{ id, name, gender, totalScore, branchOverallRank, records: { '제멀': {...}, ... } }, ...]
                    filterByGender();
                } else {
                    tbody.innerHTML = `<tr><td colspan="20">데이터 로딩 실패.</td></tr>`;
                }
            } catch (error) {
                console.error("Report data loading error:", error);
                tbody.innerHTML = `<tr><td colspan="20">서버 연결 오류.</td></tr>`;
            }
        }

        // 4) 성별 필터링
        function filterByGender() {
            const selectedGender = document.getElementById('gender-filter').value;
            const dataToShow = (selectedGender === 'all')
                ? branchData
                : branchData.filter(student => student.gender === selectedGender);

            displayAverages(dataToShow);

            // 기본 정렬: 총점 내림차순 (1등부터)
            sortReport('totalScore', dataToShow, true);
        }

        // 5) 기록 포맷
        function formatRecord(event, recordValue) {
            if (recordValue === null || recordValue === undefined || isNaN(recordValue)) return '-';
            const recordNum = parseFloat(recordValue);
            if (event === '10m') return `${recordNum.toFixed(2)} 초`;
            if (event === '제멀') return `${recordNum.toFixed(0)} cm`;
            if (event === '좌전굴') return `${recordNum.toFixed(1)} cm`;
            const unit = (event === '메디신볼') ? ' m' : ' kg';
            return `${recordNum.toFixed(1)}${unit}`;
        }

        // 6) 평균 계산 및 표시
        function displayAverages(data) {
            for (const event in EVENTS) {
                const elementId = EVENTS[event];
                const records = data
                    .map(s => s.records[event]?.record)
                    .filter(r => r !== undefined && r !== null && !isNaN(parseFloat(r)));

                let average = '-';
                if (records.length > 0) {
                    const sum = records.reduce((total, record) => total + parseFloat(record), 0);
                    average = formatRecord(event, sum / records.length);
                }
                document.getElementById(elementId).textContent = average;
            }
        }

        // 7) 테이블 렌더링
        function renderReportTable(data) {
            const tbody = document.getElementById('report-body');
            let rows = '';

            data.forEach((student, index) => {
                rows += `<tr>
                    <td>${index + 1}</td>
                    <td>${student.gender}</td>
                    <td>${student.name}</td>
                    <td>${student.totalScore || '-'}</td>
                    <td>${student.branchOverallRank || '-'}</td>`;

                Object.keys(EVENTS).forEach(eventKey => {
                    const rec = student.records[eventKey];
                    const formattedRecord = rec ? formatRecord(eventKey, rec.record) : '-';
                    const rank = rec?.branchRank || '-';

                    rows += `
                        <td>${formattedRecord}</td>
                        <td>${rec ? rec.score : '-'}</td>
                        <td>${rank}</td>`;
                });

                rows += `</tr>`;
            });

            tbody.innerHTML = rows || `<tr><td colspan="20">표시할 데이터가 없습니다.</td></tr>`;
        }

        // 8) 정렬 함수 (총점 / 지점 종합순위 / 종목별 순위)
        function sortReport(sortBy, dataToSort = null, forceSort = false) {
            const gender = document.getElementById('gender-filter').value;
            const currentFilteredData = dataToSort || branchData.filter(student => {
                return gender === 'all' || student.gender === gender;
            });

            let direction;
            if (forceSort && sortBy === 'totalScore') {
                // 처음 로딩/필터 시: 총점은 항상 내림차순(1등부터)
                direction = 'desc';
            } else {
                const currentDirection = sortDirections[sortBy];
                direction = (currentDirection === 'asc' && !forceSort) ? 'desc' : 'asc';
            }
            sortDirections = { [sortBy]: direction };

            currentFilteredData.sort((a, b) => {
                let valA, valB;

                if (sortBy === 'totalScore') {
                    valA = a.totalScore || 0;
                    valB = b.totalScore || 0;
                } else if (sortBy === 'overallRank') {
                    valA = a.branchOverallRank || 9999;
                    valB = b.branchOverallRank || 9999;
                } else {
                    // 종목별 순위: records[event].branchRank 사용
                    valA = a.records[sortBy]?.branchRank || 9999;
                    valB = b.records[sortBy]?.branchRank || 9999;
                }

                valA = (valA === '-' || valA === null || valA === undefined) ? 9999 : valA;
                valB = (valB === '-' || valB === null || valB === undefined) ? 9999 : valB;

                return direction === 'asc' ? valA - valB : valB - valA;
            });

            renderReportTable(currentFilteredData);
        }

        // 9) 엑셀 다운로드
        function downloadExcel() {
            const table = document.getElementById('report-table');
            const genderFilter = document.getElementById('gender-filter').value;
            const file_name = `${currentBranch || '전체'}_${genderFilter}_결과(지점순위).xls`;

            const style = `<style> table, th, td { border: 1px solid black; border-collapse: collapse; text-align: center; } </style>`;
            const template = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                    <meta name=ProgId content=Excel.Sheet>
                    <meta name=Generator content="Microsoft Excel 11">
                    ${style}
                </head>
                <body><table border="1">${table.innerHTML}</table></body></html>`;

            const base64 = (s) => window.btoa(unescape(encodeURIComponent(s)));
            const uri = 'data:application/vnd.ms-excel;base64,';

            const link = document.createElement('a');
            link.href = uri + base64(template);
            link.download = file_name;
            link.click();
        }

        // 시작 시 지점 목록부터 로딩
        window.onload = loadBranches;
    </script>
</body>
</html>
