<!DOCTYPE html>
<html lang="ko">
<head>
    <title>ë§ˆìŠ¤í„° í•™ìƒ ì¼ê´„ ë“±ë¡</title>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12/dist/handsontable.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/handsontable@12/dist/handsontable.full.min.css" rel="stylesheet">

    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        h1 { text-align: center; }
        .form-section { border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        button { font-size: 1.2em; padding: 15px 30px; cursor: pointer; color: white; border: none; border-radius: 8px; margin-top: 15px; background-color: #28a745; }
        .instructions { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        #spreadsheet { width: 100%; height: 500px; overflow: hidden; }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ (ì„ íƒ ì‚¬í•­) */
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>ë§ˆìŠ¤í„° í•™ìƒ ì¼ê´„ ë“±ë¡</h1>

        <div class="form-section">
            <div class="instructions">
                ğŸ’¡ ì—‘ì…€ì—ì„œ **êµìœ¡ì›, ì´ë¦„, ì„±ë³„, í•™êµ, í•™ë…„** ìˆœì„œë¡œ ë³µì‚¬í•´ì„œ ì²« ë²ˆì§¸ ì…€ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
            </div>
            <div id="spreadsheet"></div>
            <button onclick="addStudentsInBulk()">ì „ì²´ ëª…ë‹¨ ì¼ê´„ ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div class="loader-overlay" id="loaderOverlay"><div class="loader"></div></div>

    <script>
        const API_URL = 'https://supermax.kr';
        const container = document.getElementById('spreadsheet');
        const hot = new Handsontable(container, {
            data: Handsontable.helper.createEmptySpreadsheetData(3000, 5), // í–‰ ê°œìˆ˜ëŠ” ë„‰ë„‰í•˜ê²Œ
            colHeaders: ['êµìœ¡ì›', 'ì´ë¦„', 'ì„±ë³„', 'í•™êµ', 'í•™ë…„'],
            columns: [
                {}, // êµìœ¡ì›
                {}, // ì´ë¦„
                { type: 'dropdown', source: ['ë‚¨', 'ì—¬'] }, // ì„±ë³„
                {}, // í•™êµ
                {}  // í•™ë…„
            ],
            rowHeaders: true,
            colWidths: [150, 100, 80, 150, 100],
            height: 500,
            licenseKey: 'non-commercial-and-evaluation'
        });

        // ë¡œë”© ì˜¤ë²„ë ˆì´ ì œì–´ í•¨ìˆ˜
        function showLoader(show) {
            const overlay = document.getElementById('loaderOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        async function addStudentsInBulk() {
            const allGridData = hot.getData();
            // ë¹„ì–´ìˆì§€ ì•Šì€ í–‰ë§Œ í•„í„°ë§
            const pastedData = allGridData.filter(row => row.some(cell => cell !== null && cell !== undefined && cell !== ''));

            if (pastedData.length === 0) {
                return alert('ë“±ë¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            // ë°ì´í„° ì •ë¦¬ (ì•ë’¤ ê³µë°± ì œê±°)
            const cleanedData = pastedData.map(row => {
                return row.map(cell => (typeof cell === 'string' ? cell.trim() : cell));
            });

            // ìœ íš¨ì„± ê²€ì‚¬ (í•„ìˆ˜ í•„ë“œ: êµìœ¡ì›, ì´ë¦„, ì„±ë³„, í•™ë…„)
            let invalidRowsByBranch = {};
            let invalidRowCount = 0;
            const validStudents = cleanedData.map((row, index) => {
                const student = { branch: row[0], name: row[1], gender: row[2], school: row[3], grade: row[4] };
                const missingFields = [];
                if (!student.branch) missingFields.push('êµìœ¡ì›');
                if (!student.name) missingFields.push('ì´ë¦„');
                if (!['ë‚¨', 'ì—¬'].includes(student.gender)) missingFields.push('ì„±ë³„');
                if (!student.grade) missingFields.push('í•™ë…„');

                if (missingFields.length === 0) {
                    return student; // ìœ íš¨í•œ ë°ì´í„°
                } else {
                    // ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° ì •ë³´ ê¸°ë¡
                    const branchName = student.branch || '[êµìœ¡ì› ë¯¸ì…ë ¥]';
                    if (!invalidRowsByBranch[branchName]) {
                        invalidRowsByBranch[branchName] = [];
                    }
                    // ì›ë˜ í–‰ ë²ˆí˜¸ (Handsontableì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1)
                    // ì‹¤ì œ ë°ì´í„° í–‰ ë²ˆí˜¸ë¥¼ ì°¾ìœ¼ë ¤ë©´ pastedData ê¸°ì¤€ index ì‚¬ìš©
                    const originalRowIndex = allGridData.findIndex(originalRow =>
                        originalRow.every((val, i) => val === pastedData[index][i])
                    );
                    invalidRowsByBranch[branchName].push(`- ${originalRowIndex + 1}ë²ˆì§¸ ì¤„ (ëˆ„ë½: ${missingFields.join(', ')})`);
                    invalidRowCount++;
                    return null; // ìœ íš¨í•˜ì§€ ì•ŠìŒ í‘œì‹œ
                }
            }).filter(s => s !== null); // null ì œì™¸í•˜ê³  ìœ íš¨í•œ í•™ìƒ ë°ì´í„°ë§Œ ë‚¨ê¹€

            // ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ í™•ì¸
            if (invalidRowCount > 0) {
                let message = `ë¶™ì—¬ë„£ì€ ${pastedData.length}ê°œ í–‰ ì¤‘ ${invalidRowCount}ê°œ í–‰ì˜ í•„ìˆ˜ ì •ë³´(êµìœ¡ì›, ì´ë¦„, ì„±ë³„, í•™ë…„)ê°€ ëˆ„ë½ë˜ì—ˆê±°ë‚˜ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n[ëˆ„ë½/ì˜¤ë¥˜ ì˜ì‹¬ ë°ì´í„° ìƒì„¸]\n`;
                for (const branch in invalidRowsByBranch) {
                    message += `â–¶ ${branch}\n${invalidRowsByBranch[branch].join('\n')}\n\n`;
                }
                message += `ë¬¸ì œê°€ ìˆëŠ” ë°ì´í„°ë¥¼ ì œì™¸í•˜ê³  ${validStudents.length}ëª…ë§Œ ë“±ë¡ì„ ê³„ì†í• ê¹Œìš”?`;
                if (!confirm(message)) {
                    return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•˜ë©´ ì¤‘ë‹¨
                }
            } else {
                // ëª¨ë“  ë°ì´í„°ê°€ ìœ íš¨í•˜ë©´ ë“±ë¡ ì—¬ë¶€ë§Œ í™•ì¸
                if (!confirm(`ì´ ${validStudents.length}ëª…ì˜ í•™ìƒì„ ë“±ë¡í• ê¹Œìš”?`)) {
                    return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•˜ë©´ ì¤‘ë‹¨
                }
            }

            // ìœ íš¨í•œ í•™ìƒ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
            if (validStudents.length === 0) {
                alert('ë“±ë¡í•  ìœ íš¨í•œ í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ----- â­ï¸ ë¶„í•  ì „ì†¡ ë¡œì§ ì œê±° ë° ì „ì²´ ì „ì†¡ìœ¼ë¡œ ìˆ˜ì • â­ï¸ -----
            console.log(`ì „ì²´ ${validStudents.length}ëª…ì˜ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ì „ì†¡í•©ë‹ˆë‹¤.`);
            showLoader(true); // ë¡œë”© ì‹œì‘

            try {
                const response = await fetch(`${API_URL}/26susi/students/master-bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // â­ï¸ ì „ì²´ validStudents ë°°ì—´ì„ bodyì— ë‹´ì•„ ì „ì†¡
                    body: JSON.stringify({ students: validStudents })
                });

                const result = await response.json(); // ì‘ë‹µ ë³¸ë¬¸ì„ JSONìœ¼ë¡œ íŒŒì‹±

                if (!response.ok) {
                    // ì„œë²„ ì‘ë‹µì´ 2xx (ì„±ê³µ) ìƒíƒœ ì½”ë“œê°€ ì•„ë‹ ê²½ìš° ì—ëŸ¬ ì²˜ë¦¬
                    // result.message ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ ì—ëŸ¬ ë©”ì‹œì§€ ì‚¬ìš©
                    throw new Error(result.message || `ì„œë²„ ì—ëŸ¬ ë°œìƒ: ${response.status} (${response.statusText})`);
                }

                // ì„±ê³µ ì‘ë‹µ ì²˜ë¦¬ (result.message ë‚´ìš©ì„ alertë¡œ ë³´ì—¬ì¤Œ)
                alert(result.message || `ì´ ${result.insertedCount || 0}ëª…ì˜ í•™ìƒ ë“±ë¡ ì™„ë£Œ!`);
                hot.loadData(Handsontable.helper.createEmptySpreadsheetData(3000, 5)); // í…Œì´ë¸” ì´ˆê¸°í™”

            } catch (error) {
                // fetch ì‹¤íŒ¨ ë˜ëŠ” ì„œë²„ ì—ëŸ¬ ì²˜ë¦¬
                console.error("ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error); // ì½˜ì†”ì— ì—ëŸ¬ ìƒì„¸ ë‚´ìš© ì¶œë ¥
                alert(`ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`); // ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            } finally {
                showLoader(false); // ë¡œë”© ì¢…ë£Œ (ì„±ê³µ/ì‹¤íŒ¨ ë¬´ê´€)
            }
            // ----- â­ï¸ ìˆ˜ì • ë â­ï¸ -----
        }
    </script>
</body>
</html>